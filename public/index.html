<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <link rel="icon" href="%PUBLIC_URL%/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="Vueì—ì„œ IDev Viewerë¥¼ ì‚¬ìš©í•˜ëŠ” ì˜ˆì œ" />
    <title>IDev Viewer Vue ì˜ˆì œ</title>

    <!-- IDev Viewer ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ -->
    <script src="%PUBLIC_URL%/idev-viewer.js"></script>
    <script>
        // ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸
        window.addEventListener('load', function () {
            console.log('ğŸŒ Vue ì˜ˆì œ: í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            if (typeof window.IdevViewer !== 'undefined') {
                console.log('âœ… Vue ì˜ˆì œ: IDev Viewer ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ë¨');
                console.log('ë²„ì „:', window.IdevViewer.getVersion());
            } else {
                console.error('âŒ Vue ì˜ˆì œ: IDev Viewer ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨');
            }
        });

        // Flutter ì•±ì˜ í™˜ê²½ ì„¤ì •ì„ ê°•ì œë¡œ ë³€ê²½
        function forceFlutterEnvironment() {
            // iframe ë‚´ë¶€ì˜ í™˜ê²½ ì„¤ì • ê°•ì œ ë³€ê²½
            const iframes = document.querySelectorAll('iframe');
            iframes.forEach(iframe => {
                try {
                    if (iframe.contentWindow) {
                        // Flutter ì•±ì˜ ì „ì—­ ê°ì²´ì—ì„œ í™˜ê²½ ì„¤ì • ë³€ê²½
                        const flutterWindow = iframe.contentWindow;

                        // 1. window.ENVIRONMENT ì„¤ì •
                        flutterWindow.ENVIRONMENT = 'development';

                        // 2. String.fromEnvironment í•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
                        if (flutterWindow.String && flutterWindow.String.fromEnvironment) {
                            const originalStringFromEnvironment = flutterWindow.String.fromEnvironment;
                            flutterWindow.String.fromEnvironment = function (name, { defaultValue } = {}) {
                                if (name === 'ENVIRONMENT') {
                                    console.log('Vue ì˜ˆì œ: String.fromEnvironment ì˜¤ë²„ë¼ì´ë“œ - ENVIRONMENTë¥¼ developmentë¡œ ê°•ì œ ì„¤ì •');
                                    return 'development';
                                }
                                return originalStringFromEnvironment.call(this, name, { defaultValue });
                            };
                        }

                        // 3. AppConfig í´ë˜ìŠ¤ ì§ì ‘ ì¡°ì‘
                        if (flutterWindow.AppConfig && flutterWindow.AppConfig.instance) {
                            try {
                                flutterWindow.AppConfig.instance.currentEnvironment = 'development';
                                console.log('Vue ì˜ˆì œ: AppConfig.instance.currentEnvironmentë¥¼ developmentë¡œ ë³€ê²½');
                            } catch (e) {
                                console.log('Vue ì˜ˆì œ: AppConfig ì¡°ì‘ ì‹œë„ ì¤‘ ì˜¤ë¥˜:', e.message);
                            }
                        }

                        // 4. API í˜¸ìŠ¤íŠ¸ ì„¤ì • ê°•ì œ ë³€ê²½
                        if (flutterWindow.AppConfig && flutterWindow.AppConfig.instance) {
                            try {
                                flutterWindow.AppConfig.instance.apiHostAws = 'https://17kj30av8h.execute-api.ap-northeast-2.amazonaws.com';
                                flutterWindow.AppConfig.instance.apiHostLegacyBase = 'https://17kj30av8h.execute-api.ap-northeast-2.amazonaws.com';
                                flutterWindow.AppConfig.instance.apiHostLegacySite = 'https://17kj30av8h.execute-api.ap-northeast-2.amazonaws.com';
                                console.log('Vue ì˜ˆì œ: API í˜¸ìŠ¤íŠ¸ ì„¤ì •ì„ AWS URLë¡œ ê°•ì œ ë³€ê²½');
                            } catch (e) {
                                console.log('Vue ì˜ˆì œ: API í˜¸ìŠ¤íŠ¸ ì„¤ì • ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', e.message);
                            }
                        }

                        // 5. fetchì™€ XMLHttpRequest ê°€ë¡œì±„ê¸°
                        if (flutterWindow.fetch) {
                            const originalFetch = flutterWindow.fetch;
                            flutterWindow.fetch = function (url, options) {
                                if (typeof url === 'string' && url.includes('localhost:3000')) {
                                    const newUrl = url.replace('localhost:3000', '17kj30av8h.execute-api.ap-northeast-2.amazonaws.com');
                                    console.log('Vue ì˜ˆì œ: fetch ìš”ì²­ URL ë³€ê²½:', url, '->', newUrl);
                                    return originalFetch.call(this, newUrl, options);
                                }
                                return originalFetch.call(this, url, options);
                            };
                        }

                        if (flutterWindow.XMLHttpRequest) {
                            const originalOpen = flutterWindow.XMLHttpRequest.prototype.open;
                            flutterWindow.XMLHttpRequest.prototype.open = function (method, url, ...args) {
                                if (typeof url === 'string' && url.includes('localhost:3000')) {
                                    const newUrl = url.replace('localhost:3000', '17kj30av8h.execute-api.ap-northeast-2.amazonaws.com');
                                    console.log('Vue ì˜ˆì œ: XMLHttpRequest ìš”ì²­ URL ë³€ê²½:', url, '->', newUrl);
                                    return originalOpen.call(this, method, newUrl, ...args);
                                }
                                return originalOpen.call(this, method, url, ...args);
                            };
                        }

                        console.log('Vue ì˜ˆì œ: iframe í™˜ê²½ ì„¤ì • ê°•ì œ ë³€ê²½ ì™„ë£Œ');
                    }
                } catch (e) {
                    // CORS ì˜¤ë¥˜ ë¬´ì‹œ
                }
            });
        }

        // DOM ë³€ê²½ ê°ì§€í•˜ì—¬ iframe ë¡œë“œ ì‹œ í™˜ê²½ ì„¤ì • ê°•ì œ ì ìš©
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    mutation.addedNodes.forEach((node) => {
                        if (node.tagName === 'IFRAME') {
                            console.log('Vue ì˜ˆì œ: iframe ê°ì§€ë¨, í™˜ê²½ ì„¤ì • ê°•ì œ ì ìš©');
                            setTimeout(forceFlutterEnvironment, 100);
                        }
                    });
                }
            });
        });

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ í›„ ê°ì§€ ì‹œì‘
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                observer.observe(document.body, { childList: true, subtree: true });
                forceFlutterEnvironment();
            });
        } else {
            observer.observe(document.body, { childList: true, subtree: true });
            forceFlutterEnvironment();
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ í™˜ê²½ ì„¤ì • í™•ì¸ ë° ê°•ì œ ì ìš©
        setInterval(forceFlutterEnvironment, 2000);

        console.log('Vue ì˜ˆì œ: Flutter ì•± í™˜ê²½ ì„¤ì • ê°•ì œ ë³€ê²½ ì¤€ë¹„ ì™„ë£Œ');
    </script>
</head>

<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div id="app"></div>
</body>

</html>